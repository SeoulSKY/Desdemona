name: Build Unity WebGL

on:
  push:
    tags:
      - v*

jobs:
  unity:
    environment: desdemona
    runs-on: ubuntu-latest

    steps:

    - name: Free Disk Space (Ubuntu)
      uses: jlumbroso/free-disk-space@main
      with:
        # this might remove tools that are actually needed,
        # if set to "true" but frees about 6 GB
        tool-cache: false
        
        # all of these default to true, but feel free to set to
        # "false" if necessary for your workflow
        android: true
        dotnet: false
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: Checkout code
      uses: actions/checkout@v3

    - name: Cache Unity Dependencies
      uses: actions/cache@v2
      with:
        path: ./desdemona/Library
        key: Library-desdemona-WebGL
        restore-keys: |
          Library-desdemona-
          Library-

    - name: Build Unity project
      uses: game-ci/unity-builder@v3
      env:
        UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
        UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
      with:
        targetPlatform: WebGL
        projectPath: desdemona
        buildMethod: Commands.Builder.Build

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}

    - name: Upload WebGL assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: desdemona/Builds/WebGL/Build/*.unityweb
        asset_name: WebGL assets
        asset_content_type: application/gzip

    - name: Upload Unity loader script
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: desdemona/Builds/WebGL/Build/*.loader.js
        asset_name: Unity loader script
        asset_content_type: application/javascript
